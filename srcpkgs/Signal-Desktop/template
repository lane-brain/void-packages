# Template file for 'Signal-Desktop'
pkgname=Signal-Desktop
version=5.0.0
revision=1
# Due to electron
# 32-bit is not supported https://github.com/signalapp/Signal-Desktop/issues/1661
archs="x86_64"
hostmakedepends="git git-lfs nodejs python3 tar yarn openssl"
depends="gtk+3 libnotify libappindicator libvips"
short_desc="Signal Private Messenger for Linux"
maintainer="Julio Galvan <juliogalvan@protonmail.com>"
license="AGPL-3.0-only"
homepage="https://github.com/signalapp/Signal-Desktop"
distfiles="https://github.com/signalapp/Signal-Desktop/archive/v${version}.tar.gz"
checksum=4ff58f5ab5f4de6477dd92069d8c2e9a830513acca527b51e0ee1c7cbe7d8627
nostrip_files="signal-desktop"

pre_build() {
	# git-lfs hook needs to be installed for one of the dependencies
	cd ${wrksrc}
	git-lfs install
	
	vsed -e 's/"node": "/&>=/' -i package.json
	# Select node-gyp versions with python3 support
	vsed -e 's/"node-gyp": "5.0.3"/"node-gyp": "6.1.0"/' -i package.json
	# https://github.com/sass/node-sass/pull/2841
	# https://github.com/sass/node-sass/issues/2716
	sed -r 's#("resolutions": \{)#"resolutions": {"node-sass/node-gyp": "^6.0.0",#' -i package.json

	# yarn cache clean needed for sqlcipher dependency to install
	# See: https://github.com/signalapp/Signal-Desktop/issues/5032
	yarn install --ignore-engines || rm -r node_modules; yarn cache clean
	yarn install --frozen-lockfile

	# Have SQLCipher dynamically link from OpenSSL
	# See https://github.com/signalapp/Signal-Desktop/issues/2634
	patch --forward --strip=1 --input="${FILESDIR}/openssl-linking.patch"

	# We can't read the release date from git so we use SOURCE_DATE_EPOCH instead
	patch --forward --strip=1 --input="${FILESDIR}/expire-from-source-date-epoch.patch"
}

do_build() {
	yarn grunt
	yarn build-release --dir
}

do_install() {
	vmkdir usr/lib/signal-desktop

	vcopy release/linux-unpacked/* usr/lib/signal-desktop

	vmkdir usr/bin
	ln -s /usr/lib/signal-desktop/signal-desktop ${DESTDIR}/usr/bin/

	vmkdir usr/share/applications
	vinstall ${FILESDIR}/signal.desktop 644 usr/share/applications/

	vmkdir usr/share/icons/hicolor
	for size in 16 32 48 128 256 1024; do
		vinstall images/icon_${size}.png 644 usr/share/icons/hicolor/${size}x${size}/apps/ signal.png
	done
}
